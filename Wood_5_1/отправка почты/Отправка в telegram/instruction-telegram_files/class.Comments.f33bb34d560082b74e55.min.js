(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{1767:function(t,e,s){"use strict";s.r(e),s.d(e,"default",(function(){return X}));var i=s(12),n=s(0),a=s(6),o=s(15),r=s(51),d=s(41),h=s(23);class l{constructor(t){this.$dom={main:t,count:n.find(t,"[data-count]"),preloader:null},this.is_root=n.bem.hasMod(this.$dom.main,"root"),this.ids=n.data(t,"ids").split(","),this.words=n.data(t,"words").split("|"),this.parent_id=n.data(t,"parent-id"),this.with_subtree="1"===n.data(t,"with-subtree")}setWait(t){this.is_root||!1===t||null!==this.$dom.preloader||(this.$dom.preloader=n.preloader(),n.append(this.$dom.main,this.$dom.preloader)),n.bem.toggle(this.$dom.main,"waiting",!1!==t)}getIds(){return this.ids}isWithSubtree(){return this.with_subtree}getParentId(){return this.parent_id}setCount(t){t>0?n.text(this.$dom.count,`${t} ${Object(d.a)(t,this.words)}`):n.remove(this.$dom.main)}substract(t){this.ids=Object(h.a)(this.ids,t)}destroy(){this.$dom=n.nullDom(this.$dom),this.ids=null,this.parent_id=null,this.with_subtree=null}}class c{constructor(){this.collection=new r.a({create:function(t){return new l(t)},destroy:function(t,e){e.destroy()}})}add(t){this.collection.addElement(t)}get(t){return this.collection.getByElement(t)}destroy(){this.collection.clear()}}var m=s(43);class u{constructor(t){this.elements={main:t.element,counter:n.bem.find(t.element,"counter")},this.handlers=t.handlers||{},this.items=[],this.items_buffer=new m.a({delay:500,onFlushEvery:this.add.bind(this)}),this.is_blocked=!1,this.is_active=!1,n.on(this.elements.main,"click",this.onClick.bind(this))}block(t){this.is_blocked=!1!==t}isBlocked(){return!0===this.is_blocked}onClick(){this.isBlocked()||this.remove(this.items[0])}delayedAdd(t){this.items_buffer.add(t)}add(t){this.items.indexOf(t)<0&&(this.items.push(t),this.updateCount(),void 0!==this.handlers.onAdd&&this.handlers.onAdd(t))}remove(t,e=!1){var s=this.items.indexOf(t);s>=0&&(this.items.splice(s,1),this.updateCount(),void 0!==this.handlers.onRemove&&this.handlers.onRemove(t,e))}activate(t){this.is_active=t,this.show(t)}show(t){n.bem.toggle(this.elements.main,"shown",t)}hide(){this.show(!1)}zero(t){n.bem.toggle(this.elements.main,"zero",t)}updateCount(){this.setCount(this.items.length)}setCount(t){n.text(this.elements.counter,t),this.zero(0===t)}destroy(){n.off(this.elements.main),this.items_buffer.destroy(),this.elements=n.nullDom(this.elements)}}var g=s(136),_=s(2),p=s(38),f=s(3);const b={};function v(t){const e=Math.round(999999999*Math.random())+"";return b[e]=t,e}var C=s(134),y=s(753),I=s(4);class w{constructor(t){this.init(t)}init(t){this.id=t.id,this.author_id=t.author_id,this.diff_limit=t.diff_limit,this.handlers=t.handlers||{},this.urls=t.urls||{},this.is_thinking=!1,this.is_updating=!1,this.updating_timer=null,this.items_ids=(t.items_ids||[]).map(w.numToString),this.last_date=t.last_date||0,this.orphan_items={},this.socket=null,this.last_socket_id=null,this.missed_buffer=new m.a({delay:100,onFlush:this.updateMissed.bind(this)}),this.subsite_model=Air.import("module.subsite_model")}static numToString(t){return t.toString()}async handle(t,e){if(void 0!==this.handlers[t])return this.handlers[t].apply(this,e)}destroy(){clearTimeout(this.updating_timer),this.listenSocket(!1),this.missed_buffer.destroy(),this.items_ids=null,this.handlers=null,this.urls=null,this.orphan_items=null}dataToItem(t){return t.id=w.numToString(t.id),t.reply_to=w.numToString(t.reply_to),t}process(t){t.length>0?t.sort((function(t,e){return t.id-e.id})).filter(this.processOne.bind(this)):this.handle("onEmptyButReady")}processOne(t){t=this.dataToItem(t),this.subsite_model.isIgnored(t.user_id)||(this.isParentExists(t.reply_to)?this.isExists(t.id)?this.modifyOne(t):this.addOne(t):this.storeOrphan(t))}isExists(t){return this.items_ids.indexOf(w.numToString(t))>=0}isParentExists(t){return!(t>0)||this.isExists(t)}addOne(t){this.items_ids.push(w.numToString(t.id)),this.handle("onAdd",[t]),this.adoptOrphans(t.id).forEach(this.addOne.bind(this))}modifyOne(t){this.handle("onModify",[t])}storeOrphan(t){_.log("comm",`Add orphan ID=${t.id} (parent ID=${t.reply_to})`),this.orphan_items[t.id]=t}adoptOrphans(t){var e,s=[];for(e in this.orphan_items)null!==this.orphan_items[e]&&this.orphan_items[e].reply_to===t&&(_.log("comm",`Parent ID=${t} adopts orphan ID=${e}`),s.push(this.orphan_items[e]),this.orphan_items[e]=null);return s}request(t,e){var s=this;f.b({url:s.urls.diff,data:{last_date:s.last_date},success:function(i){var n,a=i.length;for(n=0;n<a;n++)s.last_date=Math.max(s.last_date,i[n].date_created||0,i[n].date_updated||0);e=e?e.concat(i):i,a>=s.diff_limit?s.request(t,e):t(e)},error:function(e){t(!1,e)}})}sendItem(t,e){var s=this;if(s.isThinking())return;this.setThinkingState(!0);const i={rid:v({is_just_answered:!0,inversion:t.inversion}),text:t.text,media:JSON.stringify(t.media),donate:t.donate,reply_to:t.reply_to,creator_id:t.creator_id};let n;t.donate&&(n=Object(C.a)("")),f.c({url:this.urls.add,data:i,success:async function(t){if(t&&t.payment_url&&n)try{await function(t){return new Promise((e,s)=>{function i(t){const{origin:a}=t;if(!n||a!==location.origin)return;if(!t.data||!t.data.donates)return;window.removeEventListener("message",i),n.close();const{success:o,error:r}=t.data.donates;o?e():s(r)}n.location=t.payment_url,window.addEventListener("message",i),Object(y.a)(n,(function(){window.removeEventListener("message",i),e()}))})}(t),e(!0,t)}catch(t){Object(I.vueNotify)({type:"error",message:t}),e(!1,t)}finally{s.setThinkingState(!1)}else s.setThinkingState(!1),t&&(s.useCloakroom(t.rid,t),s.processOne(t)),s.handle("onSend"),e(!0,t)},error:function(t){n&&n.close(),s.setThinkingState(!1),e(!1,t)}})}editItem(t,e){var s=this;s.isThinking()||(this.setThinkingState(!0),f.c({url:this.urls.edit,data:{text:t.text,media:t.media,comment_id:t.edited_id},success:function(t){s.processOne(t),s.handle("onSend"),e(!0)},error:function(t){e(!1,t)},complete:function(){s.setThinkingState(!1)}}))}setThinkingState(t){this.is_thinking=!1!==t,this.handle("onThinking",[this.is_thinking])}isThinking(){return this.is_thinking}setUpdatingState(t){this.is_updating=!1!==t,this.handle("onUpdating",[this.is_updating])}update(){var t=this;clearTimeout(this.updating_timer),!1===this.is_updating?(this.setUpdatingState(!0),this.request((function(e){t.setUpdatingState(!1),e&&t.process(e)}))):this.updating_timer=setTimeout(this.update.bind(this),1e3)}loadMore(t,e){var s=this;_.log("comm","Loading more...",t),f.c({url:this.urls.load_more,data:{ids:t.ids.join("_"),with_subtree:t.with_subtree},success:function(t){_.log("comm","More loaded",t),e(t),s.process(t.items)},error:function(t){e(null,t)}})}updateMissed(t){var e=this;t.length<=3?t.forEach((function(t){f.b({url:"/live/missed/socket",data:{id:t,chan:"comments-"+e.id},success:function(t){e.processOne(t.data)},error:function(){}})})):(this.last_date=0,this.update())}listenSocket(t){!1!==t?null===this.socket&&(this.socket=new p.a({name:"comments-"+this.id,onMessage:this.processSocketMessage.bind(this)}),this.socket.open()):null!==this.socket&&(this.socket.close(),this.socket=null)}processSocketMessage(t){var e;if(_.log("comm",`Last socket #${this.last_socket_id}, receive socket #${t._id}`),null===this.last_socket_id&&(this.last_socket_id=t._id),t._id<this.last_socket_id)_.log("comm","...from past (WEIRD!)");else if(t._id-this.last_socket_id>1)for(_.log("comm","...missed"),e=this.last_socket_id+1;e<t._id;e++)this.missed_buffer.add(e);this.last_socket_id<t._id&&(this.last_socket_id=t._id),this.cloakroomHas(t.rid)||(this.useCloakroom(t.rid,t.data),this.processOne(t.data))}cloakroomHas(t){return void 0!==b[t]}useCloakroom(t,e){!function(t,e){const s=b[t];void 0!==s&&e(s)}(t,(function(t){Object(g.a)(e,t)}))}getOriginalItem(t,e){var s=this;this.setThinkingState(!0),f.b({url:this.urls.get4edit,data:{id:t},success:function(t){e(t)},error:function(t){e(!1,t)},complete:function(){s.setThinkingState(!1)}})}getIgnoredItem(t,e){var s=this;this.setThinkingState(!0),f.b({url:this.urls.get_ignored,data:{id:t},success:function(t){e(t)},error:function(t){e(!1,t)},complete:function(){s.setThinkingState(!1)}})}}var k=s(35),S=s(83),x=s(204);class T{constructor({id:t,node:e}){this.id=t,this.node=e,this.parents=e.parents,this.levelNodes=[],this.element=null,this.isHidden=!1,this.isMaxLevel=!1,this.hasMaxLevel=!1,this.isNodeFirstOnLevel=!1,this.isNodeLastOnLevel=!1}static filterVisibleNodes(t){return t.filter(t=>!t.data.is_hidden)}get isLastBranch(){return this.node.branches.indexOf(this)===this.node.branches.length-1}get state(){return JSON.stringify({isHidden:this.isHidden,isMaxLevel:this.isMaxLevel,hasMaxLevel:this.hasMaxLevel,isNodeFirstOnLevel:this.isNodeFirstOnLevel,isNodeLastOnLevel:this.isNodeLastOnLevel})}setLevelNodes(t){this.levelNodes=t}refresh(){const t=T.filterVisibleNodes(this.parents),e=T.filterVisibleNodes(this.levelNodes),s=T.filterVisibleNodes(this.node.parent.children);this.isHidden=t.some(t=>e.indexOf(t)===e.length-1),this.isMaxLevel=this.node.data.isMaxLevel&&this.isLastBranch,this.hasMaxLevel=this.node.data.hasMaxLevel&&this.isLastBranch,this.isNodeFirstOnLevel=0===s.indexOf(this.node),this.isNodeLastOnLevel=s.indexOf(this.node)===s.length-1}render(){const t=this.element||Object(n.make)("div","comment__branch"),e=this.isNodeLastOnLevel&&!this.hasMaxLevel,s=this.isNodeFirstOnLevel&&this.isMaxLevel,i=this.isHidden&&!this.hasMaxLevel,a=this.isLastBranch&&this.hasMaxLevel&&!s;return n.bem.toggle(t,"hidden",i||a),n.bem.toggle(t,"no-border",this.isLastBranch&&(e||s)),this.element||(Object(n.data)(t,"id",this.id),Object(n.attr)(t,"air-hover","comments_highlight_branch"),Object(n.attr)(t,"air-leave","comments_unhighlight_branch"),Object(n.attr)(t,"air-click","comments_collapse_branch"),this.element=t),this.element}}class B{constructor(t){this.params={rootUid:"",selfUidField:"",parentUidField:"",...t},this.tree=this.createNode(null),this.length=0,this.nodesByBranch={},this.levelNodesByBranch={}}static formBranchId(t,e){return`thread=${t}&parent=${e}`}createNode(t){return{data:t,uid:null===t?this.params.rootUid:t[this.params.selfUidField],parentUid:null===t?null:t[this.params.parentUidField],threadId:null===t?"":t.threadId,parent:null,directChildrenLength:0,totalChildrenLength:0,children:[],parents:[],parentIds:[],branches:[],level:0,index:0,rootIndex:0}}add(t){const e=this.createNode(t);return e.parent=this.getNodeByUid(e.parentUid),this.walkNodes(t=>{if(t.uid===e.parentUid){const s=t.directChildrenLength;t.directChildrenLength+=1,e.index=s,e.level=t.level+1,e.parentIds=[...t.parentIds],t.data&&(e.parentIds.push(t.uid),e.parents.push(...t.parents,t));const i=e.parentIds.slice(0,e.data.displayLevel-1).length;for(let s=0;s<i;s+=1){const i=e.parentIds[s],n=B.formBranchId(e.threadId,i),a=new T({id:n,node:e});e.branches.push(a),this.nodesByBranch[n]||(this.nodesByBranch[n]={parent:t,children:[]}),this.nodesByBranch[n].children.includes(e)||this.nodesByBranch[n].children.push(e),s===e.parentIds.length-1&&(this.levelNodesByBranch[n]||(this.levelNodesByBranch[n]={parent:t,children:[]}),this.levelNodesByBranch[n].children.includes(e)||this.levelNodesByBranch[n].children.push(e)),a.setLevelNodes(this.levelNodesByBranch[n].children)}let n=e.parent;for(;n;)n.totalChildrenLength+=1,n=n.parent;return t.children[s]=e,this.length++,null}}),e}sort(t){function e(e,s){return t(e.data,s.data,e.level)}this.walkNodes(t=>{t.children.sort(e),t.parent&&(t.index=t.parent.children.indexOf(t),this.updateNodeRootIndex(t),this.sortNodeBranch(t))})}sortNodeBranch(t){const e=B.formBranchId(t.threadId,t.parentUid);this.levelNodesByBranch[e]&&this.levelNodesByBranch[e].children.sort((t,e)=>t.index-e.index)}updateNodeRootIndex(t){let e=t;for(t.rootIndex=0;e.parent;){const s=e===t?0:1,i=e.parent.children.slice(0,e.index),n=i.reduce((t,e)=>t+=e.totalChildrenLength,0);t.rootIndex+=s+i.length+n,e=e.parent}}walkNodes(t,e=this.tree,s=0,i=0,n=null){let a;if(null===t(e,s,i,n))return null;for(a=0;a<e.directChildrenLength;a++)if(null===this.walkNodes(t,e.children[a],s+1,a,e))return null}walk(t){return this.walkNodes((e,s,i,n)=>{if(null!==e.data)return t(e,i,n)})}walkBranch(t,e){const s=this.nodesByBranch[t];if(!s)return;const i={total:s.children.length,hidden:s.children.filter(t=>t.data.is_hidden).length,visible:0,potential:0};i.visible=i.total-i.hidden,i.potential=s.parent.data.repliesToLoad,i.potential+=s.children.reduce((t,e)=>t+=e.data.repliesToLoad,0),s.children.forEach(t=>{e(t,s.parent,i)})}getNodeByUid(t){let e=null;return this.walkNodes(s=>{if(null!==s&&s.uid===t)return e=s,null}),e}getDataByUid(t){const e=this.getNodeByUid(t);return null===e?null:e.data}getLength(t){if(!t)return this.length;let e=0;return this.walk(({data:s})=>{!1!==t(s)&&e++}),e}getParentUids(t){let e=[];const s=this.getNodeByUid(t);return s&&s.parentUid&&0!=s.parentUid&&(e.push(s.parentUid),e=e.concat(this.getParentUids(s.parentUid))),e}}var O=s(16);let L=null,M=null,A=1e5,D=!1;function $(t){L=t,M=F(t)}function N(t,e){return t+.5*e}function F(t){const e=n.rect(t);return N(e.top,e.height)}var U,E=s(44);class j{constructor(t){this.id=t.id,this.handlers=t.handlers,this.collapsedBranchesIds=[],this.auth_data=Air.import("module.auth_data"),this.module_date=Air.import("module.date"),this.module_andropov=Air.import("module.andropov"),this.module_comments_admin=Air.import("module.comments_admin"),this.module_quiz=Air.import("module.quiz"),this.module_vuemate=Air.import("module.vueMate"),this.floatingScreen=Air.import("module.floatingScreen"),this.treeInstance=new B({rootUid:"0",selfUidField:"id",parentUidField:"reply_to"}),this.sorting_rules=this.createSortingRules(t.sorting_rules),this.current_sorting_rule=t.current_sorting_rule,this.current_scroll_anchor_id=null,this.render_timer=new k.a(this.render.bind(this)),this.isReady=!1,this.elements={main:t.element,content:n.bem.find(t.element,"content"),title:n.bem.find(t.element,"title"),links_to_all:n.bem.findAll(t.element,"link_to_all a"),highlightedBranches:[]},this.parseTree(this.elements.content),this.currentLength=parseInt(n.data(this.elements.title,"count")),this.updateTitle(),this.elements.links_to_all.forEach(t=>{const e=n.attr(t,"href"),{from_comment:s}=Object(E.a)(e.slice(1));if(s){const i=this.treeInstance.getParentUids(s);i.unshift(s);const a=e.replace(/from_comment=(\d+)/g,"from_comment="+i.join(","));n.attr(t,"href",a)}}),this.ready()}createSortingRules(t){var e,s={};for(e in t)s[e]=this.createSortingRule(t[e]);return s}createSortingRule(t){return function(e,s,i){if(e.is_just_answered||s.is_just_answered){const t=e.inversion||1;return t!==(s.inversion||1)?-1===t?-1:1:(e.id-s.id)*t}return t(e,s,i)||e.id-s.id}}setScrollAnchorId(t){this.current_scroll_anchor_id=t||null}rememberScroll(){L=null,M=null,A=1e5,D=!1,null===this.current_scroll_anchor_id?this.treeInstance.walk(({data:t})=>{void 0!==t.dom&&function(t){const e=N(0,Object(O.e)()),s=F(t),i=Math.abs(s-e);A>i&&(A=i,$(t))}(t.dom.item)}):($(this.treeInstance.getDataByUid(this.current_scroll_anchor_id).dom.item),this.setScrollAnchorId(null))}restoreScroll(){!1===D&&null!==L&&window.scrollBy(0,F(L)-M),D=!1}ignoreScrollRestoreOnce(){D=!0}refreshRelatedModules(){this.module_date.refresh(),this.module_andropov.refresh(),this.module_comments_admin.refresh(),this.floatingScreen.refresh(),this.module_quiz.refresh(),this.module_vuemate.refresh()}ready(){!1===this.isReady&&(this.isReady=!0,n.bem.add(this.elements.main,"ready"),this.handlers.onReady&&setTimeout(this.handlers.onReady.bind(this),0))}assimilateItem(t,e){return t.is_assimilated||(e||(e=n.parseHTML(t.html)),t.dom||(t.dom={item:e,content:n.bem.find(e,"content"),branchesContainer:n.bem.find(e,"branches"),branches:[],expandBranch:n.bem.find(e,"expand-branch")}),t.is_mine=this.auth_data.isMe(t.user_id),t.is_removed=n.bem.hasMod(t.dom.item,"removed"),t.is_hidden=n.bem.hasMod(t.dom.item,"hidden"),t.donate=parseInt(n.data(t.dom.item,"donate")),this.handlers.onItemAssimilated&&this.handlers.onItemAssimilated(t),t.highlight_counter=0,t.is_assimilated=!0,t.isCollapsed=!1,t.repliesToLoad=parseInt(n.data(t.dom.item,"replies-to-load"))),e=null,t}uncollapseAllHigher(t){this.treeInstance.getParentUids(t).forEach(t=>{this.toggleItemMod(t,"collapsed",!1)})}checkItemHighlight(t){const e=this.treeInstance.getDataByUid(t);e&&e.dom&&n.bem.toggle(e.dom.item,"highlighted",e.highlight_counter>0)}highlightBranch(t,e){e?this.treeInstance.walk(({data:e})=>{e.dom&&e.dom.branches&&e.dom.branches.forEach(e=>{n.data(e,"id")===t&&(n.bem.toggle(e,"highlighted",!0),this.elements.highlightedBranches.push(e))})}):this.elements.highlightedBranches.forEach(t=>{n.bem.toggle(t,"highlighted",!1)})}collapseBranch(t){this.collapsedBranchesIds.includes(t)||this.collapsedBranchesIds.push(t),this.treeInstance.walkBranch(t,({data:t,branches:e},{data:s},i)=>{const a=e.some(t=>this.collapsedBranchesIds.includes(t.id)),o=i.visible+i.potential;n.text(s.dom.expandBranch,`${o} ${Object(d.a)(o,["комментариев","комментарий","комментария"])}`),n.bem.toggle(s.dom.expandBranch,"visible",!0),!t.isCollapsed&&a&&(t.isCollapsed=!0,n.bem.toggle(t.dom.item,"collapsed",!0),Object(x.a)(s.dom.item)||this.scrollIntoView(s.id))})}expandBranch(t){this.collapsedBranchesIds.includes(t)&&this.collapsedBranchesIds.splice(this.collapsedBranchesIds.indexOf(t),1),this.treeInstance.walkBranch(t,({data:t,branches:e},{data:s})=>{const i=!e.some(t=>this.collapsedBranchesIds.includes(t.id));n.bem.toggle(s.dom.expandBranch,"visible",!1),t.isCollapsed&&i&&(t.isCollapsed=!1,n.bem.toggle(t.dom.item,"collapsed",!1))})}highlightItem(t,e,s){const i=this.treeInstance.getDataByUid(t);i&&i.dom&&(i.highlight_counter+=e?1:-1,i.highlight_counter<0&&(i.highlight_counter=0),this.checkItemHighlight(t),void 0!==s&&setTimeout(this.highlightItem.bind(this),s,t,!e))}parseTree(t){n.walk(t,t=>{const e=this.assimilateItem({id:n.data(t,"id"),reply_to:n.data(t,"reply_to"),user_id:parseInt(n.data(t,"user_id")),date_created:parseInt(n.data(t,"date")),result_rating:parseFloat(n.data(t,"rating")),threadId:n.data(t,"thread-id"),level:parseInt(n.data(t,"level")),displayLevel:parseInt(n.data(t,"display-level")),isMaxLevel:"1"===n.data(t,"is-max-level"),hasMaxLevel:"1"===n.data(t,"has-max-level"),hasPreMaxLevel:"1"===n.data(t,"has-pre-max-level"),isPinned:"1"===n.data(t,"is-pinned")},t);this.treeInstance.add(e)},".comment"),this.treeInstance.walk(this.renderItemBranches.bind(this))}renderItemBranches(t){t.data.is_hidden||1===t.level||t.branches.forEach((e,s)=>{const i=e.state;if(e.refresh(),i===e.state&&e.element)return;const a=t.data.dom.branches.indexOf(e.element);a>-1&&t.data.dom.branches.splice(a,1),n.remove(e.element);const o=e.render();n.appendAtIndex(t.data.dom.branchesContainer,o,s),t.data.dom.branches.push(o)})}getLastDate(){var t=0;return this.treeInstance.walk(({data:e})=>{t<e.date_created&&(t=e.date_created)}),t}getItemsIds(){var t=[];return this.treeInstance.walk(({data:e})=>{t.push(e.id)}),t}calculateHeightOfFirstNItems(t,e){const s=[];this.treeInstance.walk(({data:t})=>{if(s.length>=e)return null;t.is_hidden||s.push(t.dom.item)});return s[s.length-1].getBoundingClientRect().bottom-t.getBoundingClientRect().top}addItem(t){this.treeInstance.add(t),this.render_timer.debounce(100)}modifyItem(t,e={}){const s={keep:[],...e},i=this.treeInstance.getDataByUid(t.id);if(!i||!i.dom)return;const a=n.parseHTML(t.html),o=n.bem.find(a,"content");n.children(i.dom.content).forEach(t=>{s.keep.includes(t)||n.remove(t)}),i.dom.content.prepend(...o.children),this.render_timer.debounce(100),setTimeout(()=>{this.handlers.onItemModified&&this.handlers.onItemModified(i)},150)}insertTreeItemIntoDom(t,e=!1){const{data:s,branches:i}=t,a=i.some(t=>this.collapsedBranchesIds.includes(t.id));this.renderItemBranches(t),a&&!s.isCollapsed&&(s.isCollapsed=!0,n.bem.toggle(s.dom.item,"collapsed",!0)),n.bem.toggle(s.dom.item,"with-no-replies",!t.children.length);this.elements.content.contains(s.dom.item)&&!e||n.appendAtIndex(this.elements.content,s.dom.item,t.rootIndex)}sort(t){this.current_sorting_rule=t,this.render_timer.reset(),this.render({ignoreScrollRestorance:!0,reinsertAll:!0})}render(t={}){const e={ignoreScrollRestorance:!1,reinsertAll:!1,...t};!0!==e.ignoreScrollRestorance&&this.isReady&&this.rememberScroll(),this.treeInstance.sort(this.sorting_rules[this.current_sorting_rule]),this.treeInstance.walk(({data:t})=>{this.assimilateItem(t,t.dom&&t.dom.item)}),this.treeInstance.walk(t=>{this.insertTreeItemIntoDom(t,e.reinsertAll)}),this.updateTitle(),this.refreshRelatedModules(),!0!==e.ignoreScrollRestorance&&this.restoreScroll()}toggleItemMod(t,e,s){n.bem.toggle(this.treeInstance.getDataByUid(t).dom.item,e,s)}getElementForForm(t){const e=this.treeInstance.getDataByUid(t);return e&&e.dom?e.dom.content:null}isItemHere(t){const e=this.treeInstance.getDataByUid(t);return null!==e&&e.dom}findDataById(t){return this.treeInstance.getDataByUid(t)}scrollIntoView(t,e={},s){const{duration:i,with_animation:n}=e,a=n?"easeInOutCubic":null;let o=this.elements.main;if(t){const e=this.treeInstance.getDataByUid(t);e&&e.dom&&(o=e.dom.item)}S.a(o,{shift:-60,easing:a,duration:i},s)}scrollAndHighlight(t,e={},s){!0===e.with_animation&&(e.duration=400),this.scrollIntoView(t,e,s),this.highlightItem(t,!0,2500)}setTitle(t){if(this.currentLength===t)return;const e=t>0?`${t} ${Object(d.a)(t,["комментариев","комментарий","комментария"])}`:"Комментарии";n.data(this.elements.title,"count",t),n.html(this.elements.title,e),this.currentLength=t}updateTitle(){this.setTitle(this.getLength())}getLength(){const t=this.treeInstance.getLength(t=>!0!==t.is_removed&&!0!==t.is_hidden);return Math.max(this.currentLength,t)}destroy(){this.handlers.onDestroy&&this.handlers.onDestroy(),this.render_timer.destroy(),this.elements=n.nullDom(this.elements)}}!function(t){t.Best="best",t.Old="old"}(U||(U={}));class R{constructor(t=U.Best,e={}){this.value=t,this.handlers=e,this.state=!1,this.target=null}get items(){return[{label:"Лучшие",analyticsEvent:"Comments — Sort — Best — Click",value:U.Best,action:this.onItemSelect.bind(this)},{label:"Последние",analyticsEvent:"Comments — Sort — By Date — Click",value:U.Old,action:this.onItemSelect.bind(this)}]}setTarget(t){return this.target=t,this}toggle(){if(this.state=!this.state,this.state){if(!this.target)return this;I.vuePopover.open({target:this.target,items:this.items,selected:this.value,align:"right"}),I.vuePopover.once("close",()=>{this.state=!1})}else I.vuePopover.close();return this}onItemSelect(t){t.value&&(this.value=t.value,I.vuePopover.set("selected",this.value),"function"==typeof this.handlers.onChange&&this.handlers.onChange(t.value))}}var P,H=function(t,e,s,i){return new(s||(s=Promise))((function(n,a){function o(t){try{d(i.next(t))}catch(t){a(t)}}function r(t){try{d(i.throw(t))}catch(t){a(t)}}function d(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,r)}d((i=i.apply(t,e||[])).next())}))};!function(t){t[t.Active=1]="Active",t[t.Inactive=0]="Inactive",t[t.NotAvailable=-1]="NotAvailable"}(P||(P={}));class V{constructor(t=0,e=P.Inactive,s={}){this.contentId=t,this.state=e,this.handlers=s,this.isLoading=!1}get isSubscribed(){return this.state===P.Active}get subscriptionEndpoint(){return`/notifications/${this.isSubscribed?"unsubscribe":"subscribe"}/thread/${this.contentId}`}toggle(){return H(this,void 0,void 0,(function*(){if(this.isLoading)return this.state;this.isLoading=!0;const t=yield Object(f.e)({type:"POST",url:this.subscriptionEndpoint});return this.isLoading=!1,this.state=t.subscribe?P.Active:P.Inactive,"function"==typeof this.handlers.onChange&&this.handlers.onChange(this.state),this.state}))}}var W=s(5),q=s(17),z=s(25),J=s(1),G=s(736);class Q extends G.a{constructor(t,{id:e,subsite_id:s,events:i,is_enabled_donates:a}){super(i),this.id=e,this.subsite_id=s,this.storage_name_unsent="comments_unsent_"+e,this.delimeterSymbol=null,this.is_enabled_donates=a,this.$dom={main:t,form:n.find(t,'[data-comments="form"]'),editor:n.find(t,'[data-comments="editor"]'),branch:n.find(t,'[data-comments="branch"]'),lastContainer:t.parentNode},this.current_replying_id=0,this.current_mode="new",this.current_inversion=1,this.currentCreatorId=0,this.currentCredentialsId=0,this.module_auth_data=Air.import("module.auth_data"),this.initThesis().then(async()=>{await this.initDonateAttacher(),this.module_auth_data.on("Change",t=>{this.setUserData(t),this.initAuthorSwitcher()}),this.checkUnsent()})}get mainElement(){return this.$dom.main}async initThesis(){if(this.$dom.editor){const{default:t}=await s.e(27).then(s.bind(null,1768));this.thesis=new t(this.$dom.editor,{submitTitle:Object(J.c)("Send"),placeholder:Object(J.c)("Write a comment..."),blocksOptions:{text:{exporter:({type:t,data:e},s)=>{switch(t){case"command":switch(e.command_name){case"user":return`[@${e.id}|${e.value}]`;default:return s}case"break":return"\n";default:return s}},preImporter:t=>t.replace(/\[@(\d+)\|([^\]]+)\]/gi,'<thesis-command data-id="$1" data-value="$2" data-command_name="user">@$2</thesis-command>'),importer:t=>{switch(t.tagName.toLowerCase()){case"thesis-command":return{type:"command",data:t.dataset};default:return null}}}},events:{submit:({blocksData:t,attachedData:e})=>{const s=function(t){const e=t.trim().length,s={};return e<=0?(s.error_msg=Object(J.c)("You need to write something"),s.error_code=1):e>5e3?(s.error_msg=Object(J.c)("Comment is too long, keep it in %{ max } characters limit, please",{max:5e3}),s.error_code=2):(s.error_msg=null,s.error_code=null),s.text=t,s}(t.reduce((t,{type:e,content:s})=>(e===this.thesis.BLOCKS_TYPES.TEXT&&s&&t.push(s),t),[]).join(this.delimeterSymbol)),i=this.donateAttacher?this.donateAttacher.value:0;if(1===s.error_code&&(e.length>0||i>0)&&(s.error_msg=null,s.error_code=null),s.media=e,s.donate=i,null===s.error_msg)switch(this.current_mode){case"new":case"reply":this.callEvent("onWantAdd",{text:s.text,media:s.media,donate:s.donate,id:this.current_replying_id,inversion:this.current_inversion,creator_id:this.currentCreatorId});break;case"edit":this.callEvent("onWantEdit",{text:s.text,media:s.media,id:this.current_replying_id});break;default:this.callEvent("onSubmitError",{message:`Invalid current mode "${this.current_mode}"`})}else this.callEvent("onSubmitError",{message:s.error_msg})},cancel:()=>{this.place(null)},textChanged:t=>{t?this.storeUnsent({text:t,parent_id:this.current_replying_id}):this.storeUnsent(null),this.setFilledState()},undo:()=>{this.setFilledState()},redo:()=>{this.setFilledState()},focus:({state:t})=>{n.bem.toggle(this.$dom.form,"focused",t)},attachChanged:()=>{this.setFilledState()}},metrics:{attachMedia:"New Comment — Attach Media — Click",attachGif:"New Comment — Attach GIF — Click",attachLink:"New Comment — Attach Link — Click",deleteMedia:"New Comment — Attach Media — Delete — Click",deleteLink:"New Comment — Attach Link — Delete — Click",sendButton:"New Comment — Sent Button — Click",pastMedia:"New Comment — Shortcut — Attach Media — Press"}}),this.scroller=new z.a((t,e)=>{t===this.$dom.editor&&this.callEvent("onVisibilityChange",{isVisible:e})}),this.scroller.addElement(this.$dom.editor)}}async initDonateAttacher(){this.is_enabled_donates&&this.$dom.editor&&this.thesis&&(this.donateAttacher=await I.mount({name:"donate-attacher",props:{uploadedParent:this.thesis.$dom.donatesContainer,metrics:{attachDonate:"New Comment — Attach Donate — Click",deleteDonate:"New Comment — Attach Donate — Delete — Click"}},mountTo:this.thesis.$dom.attaches,insert:!0}),this.donateAttacher.$on("change",()=>{this.setFilledState()}))}async initAuthorSwitcher(){if(!this.module_auth_data.isManagingSubsites())return;const{name:t,avatar_url:e}=this.module_auth_data.get();this.authorSwitcher=await I.mount({name:"comment-author-switch",props:{initialAuthor:{value:this.currentCreatorId,image:e,label:t}},mountTo:this.thesis.$dom.attaches,insert:!0}),this.authorSwitcher.$on("change",t=>{this.currentCreatorId=t})}destroy(){this.module_auth_data.off(),this.donateAttacher&&this.donateAttacher.$off(),this.authorSwitcher&&this.authorSwitcher.$off(),this.thesis&&this.thesis.destroy(),this.scroller&&this.$dom.editor&&(this.scroller.removeElement(this.$dom.editor),this.scroller.destroy()),this.$dom=n.nullDom(this.$dom)}setFilledState(){if(this.thesis)if(this.donateAttacher&&this.donateAttacher.value){const t=!0;n.bem.toggle(this.$dom.form,"filled",t),this.thesis.setSubmitState(!t)}else Promise.all([this.thesis.getText(this.delimeterSymbol),this.thesis.getAttachedData()]).then(([t,e])=>{const s=!(!t&&!e.length);n.bem.toggle(this.$dom.form,"filled",s),this.thesis.setSubmitState(!s)})}setDisabledState(t){this.thesis&&this.thesis.disable(t)}setWaitingState(t){this.thesis&&this.thesis.wait(t)}storeUnsent(t=null){t?q.d(this.storage_name_unsent,t,!0):q.c(this.storage_name_unsent)}checkUnsent(){const t=this.getUnsent();t&&t.parent_id===this.current_replying_id?this.setText(t.text):this.setText(""),this.setFilledState()}getUnsent(){return q.b(this.storage_name_unsent,!0)}handleTextChanges(t=!0){}setText(t,e=!1){this.thesis&&(this.thesis.setText(t,this.delimeterSymbol),e&&this.thesis.markTextLinksAsParsed())}setMedia(t){this.thesis&&this.thesis.setMedia(t)}setPlaceholder(t){this.thesis&&this.thesis.setPlaceholder(t)}setFocus(t){this.thesis&&this.thesis.setFocus(t)}place(t){let e=null;switch(null===t&&(t={mode:"new",level:1}),this.callEvent("beforePlaced",t,this.$dom),this.clear(),this.authorSwitcher&&(this.authorSwitcher.setDisabled("edit"===t.mode),this.authorSwitcher.setAlign(t.level>7?"right":"left")),t.mode){case"new":e=t.container?t.container:this.$dom.lastContainer,n.append(e,this.$dom.main),t.trigger&&(this.current_inversion=parseInt(n.data(t.trigger,"inversion"))),t.container&&(this.$dom.lastContainer=t.container),n.bem.toggle(this.$dom.form,"replying",!1),n.bem.toggle(this.$dom.form,"editing",!1),this.setPlaceholder(Object(J.c)("Write a comment...")),this.setButtonTitle({text:Object(J.c)("Send"),icon:"v_long_up",isShort:!1}),this.thesis&&this.thesis.removeCustomButtons(),this.donateAttacher&&this.donateAttacher.setDisabled(!1),this.current_mode="new",this.current_replying_id=0;break;case"reply":n.append(t.container,this.$dom.main),n.bem.toggle(this.$dom.form,"replying",!0),n.bem.toggle(this.$dom.form,"editing",!1),this.setPlaceholder(Object(J.c)("Write a reply...")),this.setButtonTitle({text:Object(J.c)("Reply"),icon:"v_long_up",isShort:t.level>1}),this.thesis&&(this.thesis.addCustomButton({name:"cancel",label:Object(J.c)("Cancel")},!0),t.level>=5&&this.thesis.hideGifButton()),this.donateAttacher&&this.donateAttacher.setDisabled(!0),this.current_mode="reply",this.current_replying_id=t.id,this.current_inversion=-1;break;case"edit":n.append(t.container,this.$dom.main),n.bem.toggle(this.$dom.form,"replying",!1),n.bem.toggle(this.$dom.form,"editing",!0),this.current_mode="edit",this.current_replying_id=t.id,this.current_inversion=1,this.setPlaceholder(Object(J.c)("Edit the comment...")),this.setButtonTitle({text:Object(J.c)("Edit"),icon:"v_tick",isShort:t.level>1}),this.thesis&&this.thesis.addCustomButton({name:"cancel",label:Object(J.c)("Cancel")},!0),this.donateAttacher&&this.donateAttacher.setDisabled(!0),this.callEvent("requireOriginalData",t.id);break;default:console.warn("comm","Form: Invalid place options",t)}this.checkUnsent(),this.setFocus(!0===t.focus),this.callEvent("afterPlaced",t,this.$dom)}setButtonTitle({text:t,icon:e,isShort:s}){this.thesis&&this.thesis.setSubmitTitle({text:t,icon:e,isShort:s})}clear(){this.thesis&&this.thesis.clear(),this.donateAttacher&&this.donateAttacher.clear(),this.resetCreator()}setUserData(t){t&&(this.currentCredentialsId=t.id,this.currentCreatorId=this.currentCredentialsId)}resetCreator(){this.currentCreatorId=this.currentCredentialsId,this.authorSwitcher&&this.authorSwitcher.reset()}}var Y=s(10),K=s(135);class X{constructor(t){const e=this;this.settings=JSON.parse(n.html(n.find(t.element,"[air-settings]"))),this.$dom={main:t.element},this.controlling_module=t.controlling_module,this.module_DOM=new W.a,this.module_ajaxify=Air.import("module.ajaxify"),this.comments_last_visit=Air.import("module.comments_last_visit"),this.is_activated=!1,this.current_visit_time=this.comments_last_visit.getCurrentTime(),this.last_visit_time=this.settings.last_count_and_date?this.settings.last_count_and_date.date:this.comments_last_visit.getLocalLastTime(this.settings.id),this.currentSortingName=i.a("comments_sorting")||"best",this.subscriptionState=this.settings.subscription_state,this.lastCommentForReply=null,this.commentsSortingInstance=new R(this.currentSortingName,{onChange:t=>{this.CommentsTree_instance.sort(t),i.c("comments_sorting",t,365)}}),this.commentsSubscribeInstance=new V(this.settings.id,this.subscriptionState,{onChange:t=>{this.subscriptionState=t}}),this.CommentsFolding_instance=new c,this.CommentsUpdates_instance=new u({element:n.find(t.element,".comments_updates"),handlers:{onAdd:function(t){e.CommentsTree_instance.toggleItemMod(t,"new",!0)},onRemove:function(t,s){s||(e.CommentsUpdates_instance.block(!0),e.CommentsTree_instance.uncollapseAllHigher(t),e.CommentsTree_instance.scrollAndHighlight(t,{with_animation:!0},(function(){e.CommentsUpdates_instance.block(!1)}))),e.CommentsTree_instance.toggleItemMod(t,"new",!1)}}}),this.CommentsTree_instance=new j({element:t.element,id:this.settings.id,handlers:{onReady:function(){e.processQuery(!1),n.delegateEvent(t.element,".comment","mouseover",(function(){e.CommentsUpdates_instance.remove(n.data(this,"id"),!0)}))},onItemAssimilated:function(t){if(!1===t.is_mine){const s=null!==e.last_visit_time&&t.date_created>e.last_visit_time,i=null===e.last_visit_time&&t.date_created>e.current_visit_time;(s||i)&&e.CommentsUpdates_instance.delayedAdd(t.id)}e.controlling_module.triggerChain("Comment assimilated",t)},onItemModified:function(t){e.controlling_module.triggerChain("Comment modified",t)},onDestroy:function(){n.off(t.element)}},sorting_rules:{best:function(t,e){return e.isPinned-t.isPinned||e.donate*!e.is_removed-t.donate*!t.is_removed||e.result_rating-t.result_rating},old:function(){return 0}},current_sorting_rule:this.currentSortingName}),this.CommentsModel_instance=new w({id:this.settings.id,author_id:this.settings.author_id,diff_limit:this.settings.diff_limit,urls:this.settings.urls,last_date:this.CommentsTree_instance.getLastDate(),items_ids:this.CommentsTree_instance.getItemsIds(),handlers:{onAdd:function(t){e.CommentsTree_instance.addItem(t)},onModify:function(t){e.CommentsTree_instance.modifyItem(t,{keep:[e.CommentsForm_instance.mainElement]})},onThinking:function(t){e.CommentsForm_instance&&(e.CommentsForm_instance.setWaitingState(t),e.CommentsForm_instance.setDisabledState(t))}}}),this.CommentsForm_instance=new Q(n.find(t.element,'[data-comments="writing"]'),{id:this.settings.id,subsite_id:this.settings.subsite_id,is_enabled_donates:this.settings.is_enabled_donates,events:{onWantAdd:t=>{this.controlling_module.trigger("Comment added"),this.CommentsModel_instance.sendItem({text:t.text,media:t.media,donate:t.donate,reply_to:t.id,inversion:t.inversion,creator_id:t.creator_id},(e,s)=>{!1!==e&&(this.CommentsForm_instance.clear(),this.CommentsForm_instance.storeUnsent(!1),this.CommentsForm_instance.place(null),t.donate&&setTimeout(()=>{this.CommentsTree_instance.scrollIntoView(s.id)},100),"dtf"===window.__codename&&Math.random()>=.66&&t.text.indexOf("╭∩╮")>=0&&Object(I.vueNotify)({type:"success",message:"(° ͜ʖ͡°)╭∩╮"}),Math.random()>=.99&&Object(I.vueNotify)({type:"success",message:Math.random()<.5?"Отличный комментарий, так держать!":"Нет ничего лучше хорошего комментария"}))}),Object(Y.sendDefaultEvent)("Comments — Submit — Click"),t.donate&&Object(Y.sendDefaultEvent)("Comments — Submit with donation — Click")},onWantEdit:t=>{this.controlling_module.trigger("Comment edited"),this.CommentsModel_instance.editItem({text:t.text,media:t.media,edited_id:t.id},t=>{!1!==t&&(this.CommentsForm_instance.clear(),this.CommentsForm_instance.storeUnsent(!1),this.CommentsForm_instance.place(null))})},requireOriginalData:t=>{this.CommentsForm_instance.setDisabledState(!0),this.CommentsModel_instance.getOriginalItem(t,t=>{this.CommentsForm_instance.setDisabledState(!1),t&&(this.CommentsForm_instance.setText(t.pure_text,!0),this.CommentsForm_instance.setMedia(t.media),this.CommentsForm_instance.setFocus(!0))})},onSubmitError:t=>{Object(I.vueNotify)({type:"success",message:t.message})},beforePlaced:(t,e)=>{this.CommentsTree_instance.setScrollAnchorId(t.id||null);const s=t.id?this.CommentsTree_instance.findDataById(t.id):null;if(this.lastCommentForReply){const{branches:t,item:s}=this.lastCommentForReply.dom,i=t.indexOf(e.branch);i>-1&&t.splice(i,1),n.bem.toggle(s,"replying",!1)}if(s){const t=B.formBranchId(s.threadId,s.id);return n.attr(e.branch,"data-id",t),n.bem.toggle(e.branch,"no-border",s.hasPreMaxLevel),n.bem.toggle(e.branch,"hidden",s.hasMaxLevel),s.dom.branches.push(e.branch),n.bem.toggle(s.dom.item,"replying",!0),void(this.lastCommentForReply=s)}n.attr(e.branch,"data-id",null),n.bem.toggle(e.branch,"no-border",!1),n.bem.toggle(e.branch,"hidden",!1),this.lastCommentForReply=null},afterPlaced:t=>{!a.g||"reply"!==t.mode&&"edit"!==t.mode||this.CommentsTree_instance.scrollAndHighlight(t.id)},onVisibilityChange:({isVisible:t})=>{const e=this.is_activated,s=this.CommentsUpdates_instance.is_active;a.g&&e&&(t&&s&&this.CommentsUpdates_instance.activate(!1),t||s||this.CommentsUpdates_instance.activate(!0))}}}),this.module_DOM.on("place_form",t=>{let e=null;switch(t.data.to){case"before_me":e={mode:"new",trigger:t.el,container:t.el.parentNode,focus:!0,level:parseInt(t.data.level)};break;case"item":e={mode:t.data.mode,id:t.data.id,trigger:t.el,container:this.CommentsTree_instance.getElementForForm(t.data.id),focus:!0,level:parseInt(t.data.level)}}this.CommentsForm_instance.place(e)}),this.module_DOM.on("comments_highlight_branch",t=>{this.CommentsTree_instance.highlightBranch(n.data(t.el,"id"),!0)}),this.module_DOM.on("comments_unhighlight_branch",t=>{this.CommentsTree_instance.highlightBranch(n.data(t.el,"id"),!1)}),this.module_DOM.on("comments_collapse_branch",t=>{this.CommentsTree_instance.collapseBranch(n.data(t.el,"id"))}),this.module_DOM.on("comments_expand_branch",t=>{this.CommentsTree_instance.expandBranch(n.data(t.el,"id"))}),this.module_DOM.on("comments_highlight_id",t=>{this.CommentsTree_instance.highlightItem(n.data(t.el,"id"),!0)}),this.module_DOM.on("comments_unhighlight_id",t=>{this.CommentsTree_instance.highlightItem(n.data(t.el,"id"),!1)}),this.module_DOM.on("comments_sort",t=>{const e=n.data(t.el,"sort");this.CommentsTree_instance.sort(e),i.c("comments_sorting",e,365)}),this.module_DOM.on("load_more",t=>{this.CommentsFolding_instance.add(t.el);const e=this.CommentsFolding_instance.get(t.el),s=e.getParentId(),i=this.CommentsTree_instance.findDataById(s);e.setWait(!0),this.CommentsModel_instance.loadMore({ids:e.getIds(),with_subtree:e.isWithSubtree()},t=>{e.setWait(!1),t&&(e.substract(t.items.map(t=>t.id)),e.setCount(t.remaining_count),i&&(i.repliesToLoad=t.remaining_count),this.CommentsTree_instance.setScrollAnchorId("0"!==s?s:null))})}),this.module_ajaxify.on("Scroll to comments",()=>{this.processQuery(!0)}),this.module_ajaxify.on("Before request",()=>{this.updateVisitData()}),n.on(window,"beforeunload.classComments",()=>{this.updateVisitData()}),this.module_DOM.on("copy_comment_link",({data:t})=>{const e=t.id,s=`${location.origin}${location.pathname}?comment=${e}&from=copylink&type=quick`;Object(K.a)(s).then(()=>Object(I.vueNotify)({type:"success",message:"Ссылка скопирована"})).catch(()=>Object(I.vueNotify)({type:"error",message:"Не удалось скопировать ссылку"}))}),this.module_DOM.on("commentsActionShowSorting",({el:t,event:e})=>{e.stopImmediatePropagation(),this.commentsSortingInstance.setTarget(t).toggle(),Object(Y.sendDefaultEvent)("Comments — Sort — Click")}),this.module_DOM.on("commentsActionToggleSubscribe",async({el:t})=>{n.bem.toggle(t,"disabled",!0);const e=await this.commentsSubscribeInstance.toggle(),s=n.data(t,"titles").split("|");n.bem.toggle(t,"disabled",!1),n.bem.toggle(t,"active",e),t.title=s[e],Object(Y.sendDefaultEvent)(`Comments — ${e?"Subscribe":"Unsubscribe"} — Click`)}),this.checkRolledUpHeight()}checkRolledUpHeight(){if(this.settings.rolled_up){const t=n.bem.find(this.$dom.main,"content_wrapper__container"),e=this.CommentsTree_instance.calculateHeightOfFirstNItems(t,this.settings.rolled_up_limit);n.height(t,e)}}updateVisitData(){this.comments_last_visit.setCount(this.settings.id,this.CommentsTree_instance.getLength())}unrollRolledUp(){n.bem.add(n.bem.find(this.$dom.main,"content_wrapper "),"open")}processQuery(t){const e=Object(o.e)();if(e.comments)if(e.from_comment){const t=e.from_comment.split(",");let s=null;for(;t.length>0;){const e=t.shift();if(this.CommentsTree_instance.isItemHere(e)){s=e;break}}s?this.CommentsTree_instance.scrollAndHighlight(s,{with_animation:!1}):this.scrollToAll()}else this.scrollToAll();else e.comment&&(this.CommentsTree_instance.isItemHere(e.comment)||e.hard?(this.unrollRolledUp(),this.CommentsTree_instance.scrollAndHighlight(e.comment,{with_animation:t}),void 0!==e.mode&&this.CommentsForm_instance.place({mode:e.mode,id:e.comment,container:this.CommentsTree_instance.getElementForForm(e.comment),focus:!0})):this.module_ajaxify.goTo(`?comment=${e.comment}&hard`))}scrollToAll(){this.CommentsTree_instance.scrollIntoView()}activate(t){!1!==t&&!1===this.is_activated&&(this.is_activated=!0,this.CommentsModel_instance.listenSocket(!0)),this.CommentsUpdates_instance.activate(t)}setFormText(t,e=!1){this.CommentsForm_instance.setText(t),e&&this.CommentsForm_instance.setFocus(!0)}destroy(){this.CommentsTree_instance.destroy(),this.CommentsModel_instance.destroy(),this.CommentsForm_instance.destroy(),this.CommentsUpdates_instance.destroy(),this.CommentsFolding_instance.destroy(),this.module_DOM.off(),this.module_ajaxify.off(),n.off(window,"beforeunload.classComments")}}},736:function(t,e,s){"use strict";s.d(e,"a",(function(){return i}));class i{constructor(t={},e={}){this.events=t,this.prepend=e.prepend||[],this.append=e.append||[]}callEvent(...t){const e=t.shift();void 0===this.events[e]||this.events[e].apply(this,this.prepend.concat(t).concat(this.append))}proxyMethods(t,e=[]){e.forEach(e=>{this[e]=t[e].bind(t)})}}},753:function(t,e,s){"use strict";s.d(e,"a",(function(){return i}));function i(t,e){if(!t||t.closed)return void e();const s=setInterval((function(){t.closed&&(clearInterval(s),e())}),500)}}}]);